<!DOCTYPE html>
<html lang="es">
<head>
    <%- include('partials/head');%>
</head>
<body>
    <!-- STAR HEADER -->
    <header>
        <%- include('partials/headerUser');%>
    </header>
    <!-- END HEADER-->

    <!-- STAR BREADCRUMB -->
    <div class="container-fluid py-1 mb-1" id="breadcrumb">
        <nav class="mx-4 mt-3" aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">You Are Currently Here!</li>
                <li class="breadcrumb-item text-uppercase text-white"><a href="/">Home</a></li>
                <li class="breadcrumb-item text-uppercase text-white"><a href="">acciones</a></li>
                <li class="breadcrumb-item text-uppercase text-white"><a href="/statics">estadisticas</a></li>
                <li class="breadcrumb-item text-uppercase text-white active" aria-current="page">plantas</li>
            </ol>
        </nav>
    </div>
    <!-- END BREADCRUMB -->

    <!-- START MAIN -->
    <div class="container-fluid">
        <div class="row m-auto mb-3 border-bottom border-success border-2">
            <div class="border-bottom border-success border-2">
                <h3 class="text-center mt-2"> ESTADISTICAS DE PLANTAS</h3>
            </div>
            <!-- Columna menú lateral -->
            <div class="col-md-2 p-0">
                <ul class="nav flex-column bg-light py-0 h-100" >
                    <li class="nav-item py-3 border-bottom border-dark border-1">
                        <a class="nav-link text-dark" aria-current="page" href="/statics">
                            <i class="bi bi-bar-chart-line-fill"></i>
                            Inicio 
                        </a>
                    </li>
                    <li class="nav-item py-3 border-bottom border-dark border-1 bg-success">
                        <a class="nav-link text-white" href="/query_graphic/categoriPlant">
                            <i class="fa-brands fa-pagelines"></i>
                            Plantas
                        </a>
                    </li>
                    <li class="nav-item py-3 border-bottom border-dark border-1">
                        <a class="nav-link text-dark" href="/query_graphic/summary-pays">
                            <i class="bi bi-currency-exchange"></i>
                            Ganancias
                        </a>
                    </li>
                    <li class="nav-item py-3 border-bottom border-dark border-1">
                        <a class="nav-link text-dark" href="/query_graphic/subscriptions">
                            <i class="bi bi-person-vcard"></i>
                            Inscripciones
                        </a>
                    </li>
                    <li class="nav-item py-3">
                        <a class="nav-link text-dark" href="#">
                            <i class="bi bi-gear"></i>
                            Configuración
                        </a>
                    </li>
                </ul>
            </div>
            <!-- Columna info principal -->
            <div class="col-sm-10 my-0 d-lg-flex mb-3">
                    <div class="container w-75">
                        <canvas id="top5"></canvas>
                    </div>
                    <!-- grafica rosco-->
                    <div class="container w-50">
                        <canvas id="categoriaPlanta"></canvas>
                    </div>
            </div>
        </div>
        <div class="mx-5 mb-3">
            <form method="post" action="/users/back" class="col-sm-2 g-3 justify-content-around" >
                <button type="submit" class="btn ml-auto rounded-pill px-4 backLink" id="btnBack"><i class="bi bi-skip-backward-fill"></i> | Volver</button>
            </form>
        </div>
    </div>
    <!-- END MAIN -->

    <!-- STAR FOOTER -->
    <footer>
        <%- include('partials/footer');%>
    </footer>
    <!-- END FOOTER -->
    <script>
        // definimos donde colocar las gráficas
        const ctx1 = document.getElementById('categoriaPlanta'); //categoriaPlanta
        const ctx2 = document.getElementById('top5'); //top5

        /* 1. CATEGORIAS */

        const categories = ["Caduca", "Carnívora", "Con Flor", "Exótica", "Exterior", "Herbácea", "Interior", "Leñosa", "Perenne", "Sin Flor", "Suculenta"];
        const numPlantForCategorie = JSON.parse('<%- JSON.stringify(data) %>');

        // Crear un mapa para acceder eficientemente a los datos existentes
        const existingDataMap = new Map(numPlantForCategorie.map(item => [item._id, item.count]));

        // Crear un nuevo array para almacenar los resultados actualizados
        const updatedData = [];

        // Agregamos las categorías faltantes con valor cero
        categories.forEach(category => {
        if (existingDataMap.has(category)) {
            updatedData.push({ _id: category, count: existingDataMap.get(category) });
        } else {
            updatedData.push({ _id: category, count: 0 });
        }
        });

        // Ordenanamos los resultados por categoría
        updatedData.sort((a, b) => a._id.localeCompare(b._id));

        const values = updatedData.map(item => item.count);

        // Datos de la gráfica
        const datosCategorie ={
            data: values, 
            backgroundColor: [
                '#9c84e3',
                '#ad7eda',
                '#bc79d1',
                '#c974c6',
                '#d46fbb',
                '#dd6bae',
                '#e369a1',
                '#e86794',
                '#ea6787',
                '#eb687a',
                '#e96b6e'
            ],// Color de fondo
            borderColor: [
                '#ffff'
            ],// Color del borde
            borderWidth: 1,// Ancho del borde
        };

        new Chart(ctx1, {
            type: 'doughnut',// Tipo de gráfica. Puede ser doughnut o pie
            data: {
                labels: categories,
                datasets: [
                    datosCategorie,
                ]
            },
            options:{
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Nº de plantas por Categoría',
                        font: {
                            size: 25
                        }
                    },
                    subtitle: {
                        display: true,
                        text: 'Categoría',
                        font: {
                            size: 15
                        }
                    }
                },
                animateRotate:true,
                animateScale:true,
                layout: {
                    auropadding:true
                }
            }
        });
    
        /* 2. TOP CINCO PLANTAS MÁS AÑADIDAS */

        const topFive = JSON.parse('<%- JSON.stringify(data2) %>');
        const keys = topFive.map(item => item.sciName);
        const values2 = topFive.map(item => item.gardenCount);


        const dataRanking = {
            labels: keys,
            datasets: [{
                axis: 'Ranking Plantas',
                label: 'Las más añadidas',
                data: values2,
                fill: false,       
                backgroundColor: [
                    '#5F6F52',
                    '#A9B388',
                    '#FFDC7A',
                    '#F9EBC7',
                    '#B99470',
                ],
                borderColor: [
                    '#5F6F52',
                    '#A9B388',
                    '#FFDC7A',
                    '#F9EBC7',
                    '#B99470',
                ],
                borderWidth: 2
            }]
        };

        new Chart(ctx2,{
            type: 'bar',
            data: dataRanking,
            options: {
                indexAxis: 'y',
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Ranking Plantas',
                        font: {
                            size: 30
                        }
                    },
                    subtitle: {
                        display: true,
                        text: 'Las más añadidas',
                        font: {
                            size: 15
                        }
                    }
                },
                scale: {
                    pointLabels :{
                        fontStyle: "bold",
                    }
                }
            }
        })
    
    </script>
</body>
</html>